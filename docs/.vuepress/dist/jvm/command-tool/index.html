<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>虚拟机性能监控基础工具 | 纪先生</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="ajisun-logo-circular.png">
    <script src="/assets/js/autopush-baidu.js"></script>
    <script data-website-id="b658c055-9732-46ea-ab02-681e07f7d0b1" async="async" defer="defer" src="https://www.ajisun.fun:8443/umami.js"></script>
    <meta name="description" content="以系列的方式分享Java技术，让知识更成体系；还有成长的思考和人生杂谈；日拱一卒无有尽，功不唐捐终入海！">
    
    <link rel="preload" href="/assets/css/0.styles.21c10685.css" as="style"><link rel="preload" href="/assets/js/app.93313bce.js" as="script"><link rel="preload" href="/assets/js/2.90029576.js" as="script"><link rel="preload" href="/assets/js/15.25f26031.js" as="script"><link rel="prefetch" href="/assets/js/10.cfeda5d7.js"><link rel="prefetch" href="/assets/js/11.2f0f9490.js"><link rel="prefetch" href="/assets/js/12.13caca17.js"><link rel="prefetch" href="/assets/js/13.7341e4b2.js"><link rel="prefetch" href="/assets/js/14.d494cca7.js"><link rel="prefetch" href="/assets/js/16.2806c75e.js"><link rel="prefetch" href="/assets/js/17.f59e1faa.js"><link rel="prefetch" href="/assets/js/18.d2adede0.js"><link rel="prefetch" href="/assets/js/19.1cdf46a2.js"><link rel="prefetch" href="/assets/js/20.3ef3e74c.js"><link rel="prefetch" href="/assets/js/21.2ab07850.js"><link rel="prefetch" href="/assets/js/22.61edc0ac.js"><link rel="prefetch" href="/assets/js/23.d801984d.js"><link rel="prefetch" href="/assets/js/24.9d19a7d1.js"><link rel="prefetch" href="/assets/js/25.c9d16f0e.js"><link rel="prefetch" href="/assets/js/26.6b75b4ee.js"><link rel="prefetch" href="/assets/js/27.eac7911f.js"><link rel="prefetch" href="/assets/js/28.a7979512.js"><link rel="prefetch" href="/assets/js/29.7cdc2a9c.js"><link rel="prefetch" href="/assets/js/3.1fc82fa7.js"><link rel="prefetch" href="/assets/js/30.12512fe1.js"><link rel="prefetch" href="/assets/js/31.665b73bc.js"><link rel="prefetch" href="/assets/js/32.c0decb63.js"><link rel="prefetch" href="/assets/js/33.0a43fe05.js"><link rel="prefetch" href="/assets/js/34.0a8ad0fd.js"><link rel="prefetch" href="/assets/js/35.aad7935e.js"><link rel="prefetch" href="/assets/js/36.f590d574.js"><link rel="prefetch" href="/assets/js/37.5aa97b0e.js"><link rel="prefetch" href="/assets/js/38.f8d1eaca.js"><link rel="prefetch" href="/assets/js/39.bcc21f9f.js"><link rel="prefetch" href="/assets/js/4.d6cc0df3.js"><link rel="prefetch" href="/assets/js/40.e5e390ce.js"><link rel="prefetch" href="/assets/js/41.97fcf59b.js"><link rel="prefetch" href="/assets/js/42.b0966483.js"><link rel="prefetch" href="/assets/js/43.f7dcea48.js"><link rel="prefetch" href="/assets/js/44.b356e896.js"><link rel="prefetch" href="/assets/js/45.75c1dfa9.js"><link rel="prefetch" href="/assets/js/46.3b7c86c9.js"><link rel="prefetch" href="/assets/js/47.357ac465.js"><link rel="prefetch" href="/assets/js/48.cbf43fdd.js"><link rel="prefetch" href="/assets/js/49.da1ee5ec.js"><link rel="prefetch" href="/assets/js/5.b89b4c72.js"><link rel="prefetch" href="/assets/js/50.e551eae5.js"><link rel="prefetch" href="/assets/js/51.aa06936a.js"><link rel="prefetch" href="/assets/js/52.7e354bf0.js"><link rel="prefetch" href="/assets/js/53.39193ec6.js"><link rel="prefetch" href="/assets/js/54.1c1e8f27.js"><link rel="prefetch" href="/assets/js/6.fe3213ca.js"><link rel="prefetch" href="/assets/js/7.786546e8.js"><link rel="prefetch" href="/assets/js/8.22b0940d.js"><link rel="prefetch" href="/assets/js/9.cbd2cdfb.js">
    <link rel="stylesheet" href="/assets/css/0.styles.21c10685.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://cdn.jsdelivr.net/gh/AJiSun/CDN/logo/ajisun-logo.jpeg" alt="纪先生" class="logo"> <span class="site-name can-hide">纪先生</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java相关" class="dropdown-title"><!----> <span class="title" style="display:;">Java相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/jvm/head/" class="nav-link">虚拟机系列</a></li><li class="dropdown-item"><!----> <a href="/essay/XOR/" class="nav-link">杂文</a></li></ul></div></div><div class="nav-item"><a href="/MySQL/" class="nav-link">MySQL相关</a></div><div class="nav-item"><a href="/design/pt-change/" class="nav-link">问题与设计系列</a></div><div class="nav-item"><a href="/website/" class="nav-link">网站搭建</a></div><div class="nav-item"><a href="/games/" class="nav-link">休息一下</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java相关" class="dropdown-title"><!----> <span class="title" style="display:;">Java相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/jvm/head/" class="nav-link">虚拟机系列</a></li><li class="dropdown-item"><!----> <a href="/essay/XOR/" class="nav-link">杂文</a></li></ul></div></div><div class="nav-item"><a href="/MySQL/" class="nav-link">MySQL相关</a></div><div class="nav-item"><a href="/design/pt-change/" class="nav-link">问题与设计系列</a></div><div class="nav-item"><a href="/website/" class="nav-link">网站搭建</a></div><div class="nav-item"><a href="/games/" class="nav-link">休息一下</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java虚拟机系列</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jvm/head/" class="sidebar-link">JVM运行时堆内存如何分代</a></li><li><a href="/jvm/garbage-collection/" class="sidebar-link">JVM 有哪些垃圾回收算法</a></li><li><a href="/jvm/runtime-data-area/" class="sidebar-link">JVM运行时数据区域</a></li><li><a href="/jvm/new-class/" class="sidebar-link">对象的创建和内存布局和访问定位</a></li><li><a href="/jvm/garbage-collector/" class="sidebar-link">JVM中的垃圾收集器</a></li><li><a href="/jvm/memory-allocation/" class="sidebar-link">JVM中的内存分配</a></li><li><a href="/jvm/logs/" class="sidebar-link">搞懂虚拟机的日志和日志参数</a></li><li><a href="/jvm/command-tool/" aria-current="page" class="active sidebar-link">虚拟机性能监控基础工具</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/command-jstat/" class="sidebar-link">虚拟机性能监控基础工具-jstat</a></li><li><a href="/jvm/jconsole/" class="sidebar-link">虚拟机性能监控可视化工具</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>杂文</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-0c557b5e><div class="articleInfo" data-v-0c557b5e><ul class="breadcrumbs" data-v-0c557b5e><li data-v-0c557b5e><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-0c557b5e></a></li> <li data-v-0c557b5e><a href="/categories/?category=Java%E7%9B%B8%E5%85%B3" title="分类" data-v-0c557b5e>Java相关</a></li><li data-v-0c557b5e><a href="/categories/?category=Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B3%BB%E5%88%97" title="分类" data-v-0c557b5e>Java虚拟机系列</a></li></ul> <div class="info" data-v-0c557b5e><div title="作者" class="author iconfont icon-touxiang" data-v-0c557b5e><a href="javascript:;" data-v-0c557b5e>阿纪</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-0c557b5e><a href="javascript:;" data-v-0c557b5e>2022-01-03</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">虚拟机性能监控基础工具<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="虚拟机性能监控基础工具"><a href="#虚拟机性能监控基础工具" class="header-anchor">#</a> 虚拟机性能监控基础工具</h1> <p><img src="https://cdn.jsdelivr.net/gh/AJiSun/CDN/jvm-img/jvm-8.png" alt="图片"></p> <p>前面我们了解了虚拟机的相关的技术，大概对虚拟机有一个比较系统的认识。前面的大部分是理论知识，也有些会参杂些实操，但是实际遇到问题还是远远不够的，下面我们通过JDK官方的小工具来实践一下。准确的使用工具提升我们定位 ，解决问题的效率。</p> <h3 id="_1-jps-虚拟机进程状况工具"><a href="#_1-jps-虚拟机进程状况工具" class="header-anchor">#</a> 1. jps: 虚拟机进程状况工具</h3> <p><strong>jps(JVM Process Status Tool)</strong> 是虚拟机进程状态的工具，可以列出虚拟机正在运行的虚拟机进程，并像是虚拟机执行主类(Main Class, main()函数所在的类) 名称以及这些进程的本地虚拟机唯一的ID(LVMID，Local Virtual Machine Identifier)。此命令绝对是使用频率最高的JDK命令行工具了(因为其他的JDK工具大多需要输入它查询到的LVMID来确定要监控的是哪一个虚拟机进程)。</p> <p>对于本地虚拟机进程来说，LVMID与操作系统的进程ID（PID，Process Identifier）是一致的，使用Windows的任务管理器或者UNIX的ps命令也可以查询到虚拟机进程的LVMID，但如果同时启动了多个虚拟机进程，无法根据进程名称定位时，那就必须依赖jps命令显示主类的功能才能区分了。</p> <h5 id="jps命令格式"><a href="#jps命令格式" class="header-anchor">#</a> jps命令格式</h5> <blockquote><p>jps [ options ] [ hostid ]</p></blockquote> <p>如下直接运行jps不加任何参数</p> <div class="language-shell extra-class"><pre class="language-shell"><code>ajisun@ajisun-2 /<span class="token operator">&gt;</span> jps
<span class="token number">537</span> Check
<span class="token number">51565</span> Jps
</code></pre></div><p>这个输出可以看出当前系统共存在4个应用程序，其中第二个Jps的是这个命令本身(这个命令本质也是一个Java程序)。</p> <p>Jps 还可以加参数来控制输出(-q, -m, -l,- v)。</p> <h4 id="jps-q"><a href="#jps-q" class="header-anchor">#</a> jps -q</h4> <p>只输出进程ID(LVMID)，省略主类的名称</p> <div class="language-shell extra-class"><pre class="language-shell"><code>ajisun@ajisun-2 /<span class="token operator">&gt;</span> jps -q
<span class="token number">51573</span>
<span class="token number">537</span>
</code></pre></div><h4 id="jps-m"><a href="#jps-m" class="header-anchor">#</a> jps -m</h4> <p>输出虚拟机进程启动时传递给主类main()函数的参数</p> <div class="language-shell extra-class"><pre class="language-shell"><code>ajisun@ajisun-2 /<span class="token operator">&gt;</span> jps -m
<span class="token number">51585</span> Jps -m
<span class="token number">537</span> Check Point/Mobile Access/CShell.jar
</code></pre></div><h4 id="jps-l"><a href="#jps-l" class="header-anchor">#</a> jps -l</h4> <p>输出主类的全名，如果进程执行的是jar包，输出jar路径</p> <div class="language-shell extra-class"><pre class="language-shell"><code>ajisun@ajisun-2 /<span class="token operator">&gt;</span> jps -l
<span class="token number">51639</span> sun.tools.jps.Jps
<span class="token number">537</span> /Users/ajisun/Library/Check
</code></pre></div><h4 id="jps-v"><a href="#jps-v" class="header-anchor">#</a> jps -v</h4> <p>输出虚拟机进程启动时JVM的参数</p> <div class="language-shell extra-class"><pre class="language-shell"><code>ajisun@ajisun-2 /<span class="token operator">&gt;</span> jps -v
<span class="token number">51749</span> sun.tools.jps.Jps -l -m -v -Denv.class.path<span class="token operator">=</span>.:/Library/Java/JavaVirtualMachines/jdk1.8.0_161.jdk/Contents/Home/lib/dt.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_161.jdk/Contents/Home/lib/tools.jar -Dapplication.home<span class="token operator">=</span>/Library/Java/JavaVirtualMachines/jdk1.8.0_161.jdk/Contents/Home -Xms8m
<span class="token number">537</span> /Users/ajisun/Library/Check Point/Mobile Access/CShell.jar
</code></pre></div><h3 id="_2-jinfo-java配置信息工具"><a href="#_2-jinfo-java配置信息工具" class="header-anchor">#</a> 2.jinfo: Java配置信息工具</h3> <p><strong>jinfo(Configuration Info for Java)</strong> 的作用是实时查看和调整虚拟机各项参数。</p> <p>基本语法</p> <blockquote><p>jinfo [option] {pid}</p></blockquote> <p>其中option的可以为</p> <ul><li>-flag {name}打印指定Java虚拟机的参数值。</li> <li>-flag [+|-]{name} 设置指定Java虚拟机参数的布尔值。(+代表true，-代表false)</li> <li>-flag {name}={value} 设置指定Java虚拟机的参数值</li></ul> <p>例如打印新生代晋升老年代的年龄</p> <div class="language-shell extra-class"><pre class="language-shell"><code>ajisun@ajisun-2 /<span class="token operator">&gt;</span> jinfo -flag MaxTenuringThreshold <span class="token number">11825</span>
-XX:MaxTenuringThreshold<span class="token operator">=</span><span class="token number">15</span>
</code></pre></div><p>例如显示是否打印GC信息</p> <div class="language-shell extra-class"><pre class="language-shell"><code>ajisun@ajisun-2 /<span class="token operator">&gt;</span> jinfo -flag PrintGC <span class="token number">12046</span>
-XX:-PrintGC
</code></pre></div><p>除了上面的查找参数外，还支持设置参数(不是所有的参数都支持这种设置)</p> <p>手动打开gc日志的参数可以动态开启或者关闭</p> <div class="language-shell extra-class"><pre class="language-shell"><code>ajisun@ajisun-2 /<span class="token operator">&gt;</span> jinfo -flag PrintGC <span class="token number">12190</span>  // 查看参数 未设置
-XX:-PrintGC
ajisun@ajisun-2 /<span class="token operator">&gt;</span> jinfo -flag +PrintGC <span class="token number">12190</span>  //设置参数
ajisun@ajisun-2 /<span class="token operator">&gt;</span> jinfo -flag PrintGC <span class="token number">12190</span>   // 查看参数已设置
-XX:+PrintGC
</code></pre></div><h3 id="_3-jmap-java内存映射工具"><a href="#_3-jmap-java内存映射工具" class="header-anchor">#</a> 3. jmap: Java内存映射工具</h3> <p><strong>jmap(Memory Map for Java)</strong> 命令用于生成堆转储快照（一般称为heapdump或dump文件）。jmap的作用并不仅仅是为了获取堆转储快照，它还可以查询finalize执行队列、Java堆和方法区的 详细信息，如空间使用率、当前用的是哪种收集器等。</p> <p>基本语法</p> <blockquote><p>jmap [option] {pid}</p></blockquote> <p>其中option可以为</p> <ul><li>-dump：生成java堆转储快照，格式为：-dump:[live,]format=b,file={filename},其中live子参数说明是否只dump出存活对象。</li> <li>-finalizerinfo：显示在F-Queue中等待Finalizer线程执行finalize方法的对象，只在linux/solaris平台下有效。</li> <li>-heap：显示堆详细信息，如使用哪种回收期、参数配置、分带状况等，只在linux/solaris平台下有效。</li> <li>-histo：显示堆中对象统计信息，包括类、实例数量和合计容量。</li> <li>-clstats：以ClassLoader为统计口径显示永久代内存状况，只在linux/solaris平台下有效。</li> <li>-F：当虚拟机进程对-dump选项没有响应时，可以使用这个选项强制生成dump快照，只在linux/solaris平台下有效。</li></ul> <p>dump导出应用程序的快照</p> <div class="language-shell extra-class"><pre class="language-shell"><code>ajisun@ajisun-2 /<span class="token operator">&gt;</span> jmap -dump:format<span class="token operator">=</span>b,file<span class="token operator">=</span>/Users/ajisun/Desktop/jvmTest/s.txt <span class="token number">13157</span>
Dumping heap to /Users/ajisun/Desktop/jvmTest/s.txt <span class="token punctuation">..</span>.
Heap dump <span class="token function">file</span> created
</code></pre></div><img src="https://cdn.jsdelivr.net/gh/AJiSun/CDN/jvm-img/jvm-8-jmap-1.png"> <p>可以用jhat或者其他工具分析此快照。</p> <h3 id="_4-jhat-分析java应用程序的堆快照内容"><a href="#_4-jhat-分析java应用程序的堆快照内容" class="header-anchor">#</a> 4. jhat: 分析Java应用程序的堆快照内容</h3> <p><strong>jhat(JVM Heap Analysis Tool)</strong> 命令是jdk提供的与jmap搭配使用，来分析jmap生成的堆转储快照。</p> <p>如上文dump的文件</p> <div class="language- extra-class"><pre class="language-text"><code>ajisun@ajisun-2 /&gt; jhat /Users/ajisun/Desktop/jvmTest/s.txt
Reading from /Users/ajisun/Desktop/jvmTest/s.txt...
Dump file created Tue Jan 04 15:05:15 CST 2022
Snapshot read, resolving...
Resolving 19265 objects...
Chasing references, expect 3 dots...
Eliminating duplicate references...
Snapshot resolved.
Started HTTP server on port 7000
Server is ready.
</code></pre></div><p>上面输出是分析后的内容，还可以在浏览器中查看，访问http://localhost:7000</p> <img src="https://cdn.jsdelivr.net/gh/AJiSun/CDN/jvm-img/jvm-8-jhat-1.png"> <p>如图显示的信息是一个链接，分析内存泄露问题主要会用到“<strong>Show heap histogram</strong>” 和“<strong>OQL</strong>”，前者可以找到内存中总容量最大的对象，后者是标准的对象查询语言，使用类似于SQL的语法对内存对象进行查询统计(点击下图中的OQL Help 可以查看其语法)</p> <img src="https://cdn.jsdelivr.net/gh/AJiSun/CDN/jvm-img/jvm-8-jhat-2.png"> <blockquote><p>号外：一般不会用直接使用jhat来分析快照，一是分析快照需要占用较多服务器资源，二是这个分析的比较简单 还有更好的分析工具可用，如VisualVM。</p></blockquote> <h3 id="_5-jstack-java堆栈跟踪工具"><a href="#_5-jstack-java堆栈跟踪工具" class="header-anchor">#</a> 5. jstack: Java堆栈跟踪工具</h3> <p><strong>jstack(Stack Trace for Java)</strong> 命令用于生成虚拟机当前时刻的线程快照（一般称为threaddump或者 javacore文件）。线程快照就是当前虚拟机内每一条线程正在执行的方法堆栈的集合，生成线程快照的目的通常是定位线程出现长时间停顿的原因，如线程间死锁、死循环、请求外部资源导致的长时间挂起等，都是导致线程长时间停顿的常见原因。线程出现停顿时通过jstack来查看各个线程的调用堆栈，就可以获知没有响应的线程到底在后台做些什么事情，或者等待着什么资源。</p> <p>基本语法</p> <blockquote><p>jstack [ option ]  {pid}</p></blockquote> <p>其中option可以为</p> <ul><li>-F: 当正常输出的请求不被响应时，强制输出线程堆栈。</li> <li>-l: 除堆栈外，显示关于锁的信息。</li></ul> <p>例如</p> <blockquote><p><strong>ajisun@ajisun-2 /&gt; jstack -l 12190</strong></p> <p>2022-01-04 19:48:41</p> <p>Full thread dump Java HotSpot(TM) 64-Bit Server VM (25.161-b12 mixed mode):</p> <p>&quot;Attach Listener&quot; #11 daemon prio=9 os_prio=31 tid=0x00007f8f358db800 nid=0x3407 waiting on condition [0x0000000000000000]</p> <p>java.lang.Thread.State: RUNNABLE</p> <p>&quot;Service Thread&quot; #10 daemon prio=9 os_prio=31 tid=0x00007f8f360a8800 nid=0x4003 runnable [0x0000000000000000]</p> <p>java.lang.Thread.State: RUNNABLE</p> <p>.......</p></blockquote> <p>演示下while死循环信息查看</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ajisun@ajisun-2 /&gt; jps -l</p> <p>24513  com.ajisun.coding.ajisunmybatis.Test</p> <p>ajisun@ajisun-2 /&gt; jstack -l 24513</p></blockquote> <img src="https://cdn.jsdelivr.net/gh/AJiSun/CDN/jvm-img/jvm-8-jstack-1.png"> <p>上图中可以看到线程处于RUNNABLE状态， 在<code>com.ajisun.coding.ajisunmybatis.Test.main</code>方法的15行出现死循环 。出现死循环，等待，死锁等线程都可以看出具体出现的位置。</p> <p>死锁的案例</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token operator">--</span> 代码如下
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> objectA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> objectB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>objectA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;获取锁objectA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>objectB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;获取锁objectB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>objectB<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;获取锁objectB&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>objectA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;获取锁objectA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>开始使用jstack命令，先通过jps找到这个类的pid</p> <div class="language-shell extra-class"><pre class="language-shell"><code>ajisun@ajisun-2 /<span class="token operator">&gt;</span> jps -l
<span class="token number">25537</span> com.ajisun.coding.ajisunmybatis.Test
ajisun@ajisun-2 /<span class="token operator">&gt;</span> jstack -l <span class="token number">25537</span>
</code></pre></div><img src="https://cdn.jsdelivr.net/gh/AJiSun/CDN/jvm-img/jvm-8-jstack-2.png"> <p>如上图，根据输出的信息就能确定死锁的位置。以及出现死锁的两个线程互相持有对象以及等待的对象。</p> <blockquote><p>号外：jstack不仅可以得到线程的堆栈信息，还能看出是否死锁以及死锁的具体信息。</p></blockquote> <h3 id="_6-jcmd-多功能命令行"><a href="#_6-jcmd-多功能命令行" class="header-anchor">#</a> 6. jcmd：多功能命令行</h3> <p><strong>jcmd(Java Command)</strong> 虚拟机诊断命令工具，一个多功能的命令，可以导出堆，查看java进程，导出线程信息，执行GC等，从jdk1.7开始提供。</p> <p>查看当前系统中的虚拟机</p> <div class="language-shell extra-class"><pre class="language-shell"><code>ajisun@ajisun-2 /<span class="token operator">&gt;</span> jcmd -l
<span class="token number">36372</span> com.ajisun.coding.ajisunmybatis.Allocation
<span class="token number">36425</span> sun.tools.jcmd.JCmd -l
<span class="token number">11423</span> 
</code></pre></div><p>查看虚拟机36372支持的命令</p> <div class="language-shell extra-class"><pre class="language-shell"><code>ajisun@ajisun-2 /<span class="token operator">&gt;</span> jcmd <span class="token number">36372</span> <span class="token builtin class-name">help</span>
<span class="token number">36372</span>:
The following commands are available:
JFR.stop
JFR.start
JFR.dump
JFR.check
VM.native_memory
VM.check_commercial_features
VM.unlock_commercial_features
ManagementAgent.stop
ManagementAgent.start_local
ManagementAgent.start
GC.rotate_log
Thread.print
GC.class_stats
GC.class_histogram
GC.heap_dump
GC.run_finalization
GC.run
VM.uptime
VM.flags
VM.system_properties
VM.command_line
VM.version
<span class="token builtin class-name">help</span>
</code></pre></div><p>上面输出就是此虚拟机支持的命令</p> <ul><li><p>查看虚拟机启动的时间</p> <div class="language-shell extra-class"><pre class="language-shell"><code>ajisun@ajisun-2 /<span class="token operator">&gt;</span> jcmd <span class="token number">36372</span> VM.uptime
<span class="token number">36372</span>:
<span class="token number">292.741</span> s
</code></pre></div></li> <li><p>输出线程栈信息（和jstack命令输出相同）</p> <div class="language- extra-class"><pre class="language-text"><code>ajisun@ajisun-2 /&gt; jcmd 36372 Thread.print
......
&quot;main&quot; #1 prio=5 os_prio=31 tid=0x00007f8729808800 nid=0xe03 runnable [0x0000700002b67000]
   java.lang.Thread.State: RUNNABLE
	at com.ajisun.coding.ajisunmybatis.Allocation.main(Allocation.java:39)

&quot;VM Thread&quot; os_prio=31 tid=0x00007f872a816800 nid=0x5003 runnable 
......
</code></pre></div></li> <li><p>导出堆信息（和jmap命令功能相同）</p> <div class="language- extra-class"><pre class="language-text"><code>ajisun@ajisun-2 /&gt; jcmd 36372 GC.heap_dump /Users/ajisun/Desktop/jvmTest/jcmd.txt
36372:
Heap dump file created
</code></pre></div></li></ul> <p>由<code>jcmd 36372 help</code> 命令可以看出，jcmd有很多功能，包括覆盖常用的jmap的功能，而且官方也是推荐使用jcmd替换jmap。</p> <h3 id="_7-jstat-虚拟机统计信息工具"><a href="#_7-jstat-虚拟机统计信息工具" class="header-anchor">#</a> 7. jstat：虚拟机统计信息工具</h3> <p>用于监视虚拟机各种运行状态信息的命令工具，是比较强大的，可以用来查看堆信息的详细情况。</p> <p>由于这个命令篇幅较多，在下一篇文章中详细介绍</p> <blockquote><p>说明：以上这些命令中部分会出现错误提示</p> <p>Error attaching to process: sun.jvm.hotspot.debugger.DebuggerException: Can't attach symbolicator to the process</p> <p>如果使用的mac电脑，没啥办法，但是在Linux上开启ptrace_scope就没问题的，具体的可以网上搜索下。</p></blockquote></div></div> <!----> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%B3%BB%E5%88%97" title="标签">#虚拟机系列</a></div> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/jvm/logs/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">搞懂虚拟机的日志和日志参数</div></a> <a href="/pages/command-jstat/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">虚拟机性能监控基础工具-jstat</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/jvm/logs/" class="prev">搞懂虚拟机的日志和日志参数</a></span> <span class="next"><a href="/pages/command-jstat/">虚拟机性能监控基础工具-jstat</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/website/"><div>
            搭建的自己的网站
            <!----></div></a> <span class="date">02-09</span></dt></dl><dl><dd>02</dd> <dt><a href="/games/"><div>
            休息一下
            <!----></div></a> <span class="date">01-28</span></dt></dl><dl><dd>03</dd> <dt><a href="/MySQL/"><div>
            MySQL相关技术
            <!----></div></a> <span class="date">01-20</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:sunj.guang@foxmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://www.zhihu.com/people/ajisun" title="知乎" target="_blank" class="iconfont icon-zhihu"></a><a href="https://juejin.cn/user/123624772082791" title="掘金" target="_blank" class="iconfont icon-juejin"></a><a href="https://www.cnblogs.com/sunjiguang" title="博客园" target="_blank" class="iconfont icon-bokeyuan"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>纪先生进阶指南 |  <a href="https://beian.miit.gov.cn" target="_blank">皖ICP备2022001441号</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.93313bce.js" defer></script><script src="/assets/js/2.90029576.js" defer></script><script src="/assets/js/15.25f26031.js" defer></script>
  </body>
</html>
